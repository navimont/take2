{% extends "take2baseclass.html" %}

{% block title %}
Address-Information
{% endblock %}

{% block content %}
    <script type="text/javascript">
        var georequest = new XMLHttpRequest();

        function getlatlon() {
            var adr = document.getElementById("adr_text").value;
            // replace newlines by " "
            adr = adr.replace("\n"," ")
            var country = document.getElementById("country_text").value;
            // loadMapScript ->> initializeMap
            loadMapScript();
            // send geo lookup to google
            var url="http://maps.googleapis.com/maps/api/geocode/json?address="+adr+"+"+country+"&sensor=false";
            georequest.open("GET", url, true);
            georequest.onreadystatechange = checkReply;
            georequest.send(null);
        }

        function loadMapScript() {
            var script_loaded = document.getElementById("google_map_script");
            if (!script_loaded) {
                var script = document.createElement("script");
                script.id = "google_map_script";
                script.type = "text/javascript";
                script.src = "http://maps.googleapis.com/maps/api/js?sensor=false&callback=initializeMap";
                document.body.appendChild(script);
            };
        }

        /* initialize map */
        function initializeMap() {
            var myLatlng = new google.maps.LatLng(-34.397, 150.644);
            var myOptions = {
              zoom: 8,
              center: myLatlng,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        }

        function checkReply() {
            if (georequest.readyState == 4) {
                if (georequest.status == 200) {
                    var reply = georequest.responseText;
                    var error = "";
                    var geolatlon = {};
                    try {
                        geolatlon = JSON.parse(reply);
                    } catch (e) {
                        error = e;
                    }
                    if ( 'lat' in geolatlon ) {
                        document.getElementById('lat').value = geolatlon["lat"];
                        document.getElementById('lon').value = geolatlon["lon"];
                        var adr_zoom = geolatlon["adr_zoom"];
                        document.getElementById('adr_zoom').value = adr_zoom;
                        // formatting efforts
                        document.getElementById('adr_zoom_field').innerHTML = adr_zoom;
                    }
                } else {
                }
            }
        }

        $(document).ready(function() {
            prepareCountryAutocomplete();
        });

        /*
        *  prepare value list for country autocompletion field
        */
        function prepareCountryAutocomplete() {
            $("input#country_text").autocomplete( {
                source: [
                    {% for land in landlist %}
                      "{{land.country}}",
                    {% endfor %}
                ]
                });
        }
    </script>

    <header>
      <h1>{{titlestr}}: {{name}}</h1>
    </header>

    {% for error in errors %}
        <div class="error">{{ error }}</div>
    {% endfor %}

    <form name="save" action="/save" method="POST">
        <input name="instance" type="hidden" value="{{ instance }}">

        <input class="button" type="submit" value="Save"/>
        <input type="reset" value="Cancel" onClick="window.history.back()">

        <article id="contact_form">
          {% if 'Person' in instance_list %}
              <input name="Person_key" type="hidden" value="{{ Person_key }}">
              <div class="">
                <label for="firstname">First name(s)</label>
                <input name="name" type="text" value="{{name}}">
                <span>Nickname</span>
                <input name="nickname" type="text" value="{{nickname}}">
              </div>
              <div class="">
                <label for="lastname">Last name</label>
                <input name="lastname" type="text" value="{{lastname}}">
              </div>
              <div class="">
                <label for="introduction">Introduce</label>
                <input name="introduction" type="text" value="{{introduction}}">
                {% if middleman_ref %}
                    <input name="middleman_ref" type="hidden" value="{{middleman_ref}}">
                    <input name="middleman_name" type="hidden" value="{{middleman_name}}">
                    <span class="small">Please describe your or {{ middleman_ref_name}}'s relation to this person.</span>
                {% else %}
                    <span class="small">Please describe your relation to this person.</span>
                {% endif %}
              </div>
              <div class="">
                <label for="birthday">Birthday</label>
                <select name="birthday" size="0" id="person_birthday">
                  {% for day in daylist %}
                    <option {% if birthday == day %}selected{% endif %} value="{{day}}">{{day}}</option>
                  {% endfor %}
                </select>
                <select name="birthmonth" size="0" id="person_birthmonth">
                  {% for month in monthlist %}
                    <option {% if birthmonth == month.0 %}selected{% endif %} value="{{month.0}}">{{month.1}}</option>
                  {% endfor %}
                </select>
                <select name="birthyear" size="0" id="person_birthyear">
                  {% for year in yearlist %}
                    <option {% if birthyear == year %}selected{% endif %} value="{{year}}">{{year}}</option>
                  {% endfor %}
                </select>
                <span class="small">You can leave the year out if you don't know it.</span>
              </div>
          {% endif %} <!-- Person in instance_list -->
          {% if 'Email' in instance_list %}
              <hr>
              <div class="">
                <input name="Email_key" type="hidden" value="{{ Email_key }}">
                <label for="email">Email</label>
                <input name="email" type="email" value="{{email}}">
              </div>
          {% endif %}
          {% if 'Mobile' in instance_list %}
              <div class="">
                <input name="Mobile_key" type="hidden" value="{{ Mobile_key }}">
                <label for="mobile">Mobile phone</label>
                <input name="mobile" type="tel" value="{{mobile}}">
              </div>
          {% endif %}
          {% if 'Address' in instance_list %}
              <input name="Address_key" type="hidden" value="{{ Address_key }}">
              <hr>
              <aside>
                <a class="button" href="javascript:void(0)" onClick="getlatlon();">Show on map</a>
              </aside>
              <div class="">
                <label for="adr">Address:</label>
                <textarea id="adr_text" name="adr" rows="4" cols="40">{{adr}}</textarea>
              </div>
              <div class="">
                <label for="country">Country</label>
                <input id="country_text" type="text" name="country" value="">
              </div>
              <div class="">
                <label for="landline_phone">Landline phone:</label>
                <input type="text" name="landline_phone" value="{{landline_phone}}" size="20">
                <div id="adr_zoom_field">
                  {{adr_zoom}}&nbsp;
                </div>
                <div id="coordinates_field">
                  {{adr_coordinates}}&nbsp;
                </div>
              </div>
          {% endif %}
        </article>
        <div id="map_canvas" style="height: 320px; width: 672px;">
            <!-- displays map for address lookup -->
        </div>

    </form>

{% endblock %}
