{% extends "take2baseclass.html" %}

{% block content %}
    <script type="text/javascript">
      var georequest = new XMLHttpRequest();
      var geocoder;
      var latlon;

      function geocoder_cb(results, status) {
          var place = "";
          if (status == google.maps.GeocoderStatus.OK) {
                // get data for administrative zoom: country, state, region, town
                var place = "";
                for (var ix in results[0].address_components) {
                    var admin = results[0].address_components[ix];
                    if (admin.types.indexOf("neighborhood") != -1
                        || admin.types.indexOf("sublocality") != -1
                        || admin.types.indexOf("locality") != -1 ) {
                        place = place+admin.long_name+", ";
                    }
                }
                // remove last comma
                place = place.replace(/,\s+$/,"");
          }

        // present location in header
        $("#login_user_place").text("("+place+")");
        // send location to server
        var user = $("#login_user_key").val();
        var url = "/location?user="+user+"&lat="+latlon.lat()+"&lon="+latlon.lng()+"&place="+place;
        georequest.open("GET", url, true);
        // we are not interested in any reply
        georequest.send(null);
      }

      // geolocation.getCurrentPosition error callback
      function position_error_cb (err) {
          var user = $("#login_user_key").val();
          var url = "/location?user="+user+"&err="+err.code;
          georequest.open("GET", url, true);
          // we are not interested in any reply
          georequest.send(null);
      }

      // geolocation.getCurrentPosition position callback
      function position_cb (position) {
          // geoencode position
          latlon = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          geocoder.geocode( { 'location': latlon }, geocoder_cb);
      }

      /* initialize geocoder, is called back by loadMapScript */
      function initializeGeocoder() {
          geocoder = new google.maps.Geocoder();
          // maximumAge in milliseconds
          navigator.geolocation.getCurrentPosition(position_cb, position_error_cb, {timeout: 10000, maximumAge: 300000});
      }


      function loadMapScript() {
          var script_loaded = document.getElementById("google_map_script");
          if (!script_loaded) {
              var script = document.createElement("script");
              script.id = "google_map_script";
              script.type = "text/javascript";
              script.src = "http://maps.googleapis.com/maps/api/js?sensor=false&callback=initializeGeocoder";
              document.body.appendChild(script);
          };
      }

      $(document).ready(function() {
          ask_geolocation = $("#geolocation_request").val();
          if (ask_geolocation == "True") {
              // start the chain of call backs only if we can actually retrieve position
              if (!navigator.geolocation) {
                  return;
              }
              // contains functionality for geolocation
              loadMapScript();
          }
      });
    </script>

    <!-- lets the page know when a geolocation request shall be done -->
    <input type="hidden" id="geolocation_request" value="{{geolocation_request}}"/>
    <input type="hidden" id="login_user_key" value="{{login_user_key}}"/>

    {% if signed_in %}
      <!-- Show birthdays for signed in users -->
      {% if birthdays %}
        <header>
          <h1>Birthdays</h1>
          <ul id="birthdays">
            {% for person in birthdays %}
              <li>{{ person.name }} {% if person.nickname %} ({{ person.nickname }}) {% endif %} *{{ person.birthday }}
            {% endfor %}
          </ul>
        </header>
      {% endif %}
    {% else %}
        <p>You can search for people here who have some of their contact information made public.</p>
        <p>If you want to start tour own address book, you need to <a href="/login">sign in</a>. Simply use your existing account with google, yahoo or another <a href="http://openid.net/">openId</a> provider.</p>
        <div class="vertical-space"></div>
        <div class="vertical-space"></div>
        <div class="vertical-space"></div>
    {% endif %}
    {% if result %}
        {% if query %}
          <header>
            <h1>Results for "{{ query|escape }}" ({{ result_size }} found):</h1>
          </header>
        {% endif %}
      {% for contact in result %}
        <article id="results">
          {% if signed_in %}
            <aside class="contact_navigation">
              <ul>
                {% if contact.can_edit %}
                  <li><a href="javascript:void(0)" onClick="post_to_url('/editcontact', {'key': '{{contact.key}}'});">edit</a></li>
                  {% if contact.is_myself %}
                    <!-- share entry only for myself -->
                    <li><a href="javascript:void(0)" onClick="post_to_url('/share', {'key': '{{contact.key}}'});">share</a></li>
                  {% endif %}
                {% else %}
                  <!-- <li><a href="javascript:void(0)" onClick="post_to_url('editcontact', {'key': '{{contact.key}}'});">connect</a></li> -->
                {% endif %}
                <!-- <li><a href="javascript:void(0)" onClick="post_to_url('editcontact', {'key': '{{contact.key}}'});">locate</a></li> -->
              </ul>
            </aside>
          {% endif %}
          <header>
            <h2>
              {{ contact.name }}
              {% if contact.nickname %}
                  ({{contact.nickname}})
              {% endif %}
              {{contact.lastname}}
              {% if contact.birthday %}
                  &nbsp;*{{contact.birthday}} {{contact.birthmonth}}
              {% endif %}
            </h2>
            <h3>
              {{contact.relation}}
              {% if contact.middleman_ref %}
                (related through <a id="contact_link" href="/search?key={{contact.middleman_ref}}">{{contact.middleman}}</a>)
              {% endif %}
            </h3>
          </header>
          <!-- properties for this contact -->
          {% for take2 in contact.take2 %}
            {% if take2.has_data %}
              <hr>
              {% if take2.class_name == 'Contact' or take2.class_name == 'Person' %}
                {% for data in take2.data %}
                  <a id="contact_link" href="/search?key={{data.key}}">{{data.data}}</a>
                  {% if not forloop.last %}
                    ,&nbsp;
                  {% endif%}
                {% endfor %}
              {% else %}
                <ul>
                  {% for data in take2.data %}
                    <li>{{data.data}}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            {% endif %}
          {% endfor %}
        </article>
      {% endfor %}
    {% else %}
      {% if signed_in %}
        <header>
          {% if query %}
              <h1>Nothing found for {{ query|escape }}</h1>
          {% else %}
          {% endif %}
        <header>
      {% endif %}
    {% endif %}
    {% if signed_in %}
      {% if not query %}
        {% if new_customer %}
            <div class="vertical-space"></div>
            <div class="vertical-space"></div>
            <div class="vertical-space"></div>
            <div id="new_customer">
                Start entering your data:
                <a class="button" href="javascript:void(0)" onClick="post_to_url('/edit', {'instance': 'Person,Mobile,Address', 'Person_key': '{{new_customer_key}}', 'contact_ref': '{{new_customer_key}}'})">
                Click here</a>
            </div>
        {% endif %}
        <div class="vertical-space"></div>
        <div class="vertical-space"></div>
        <h2>The search page at Weschnitz.</h2>
        <h3>What you can do from here:</h3>
          <ul>
              <li>Your personal data is displayed above. You can add phone numers, a new address etc.</li>
              <li>Use the 'New contact' menu entry in the upper right corner to add more people to your address book.</li>
          </ul>
      {% endif %}
    {% endif %}
  <footer>
  </footer>
{% endblock %}
